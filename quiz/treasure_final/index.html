<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ´â€â˜ ï¸ æœ€å¾Œã®è©¦ç·´ - å®ç®±ã®è§£éŒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8d5b7;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2rem;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            color: #ffd700;
        }

        .hint-comment {
            text-align: center;
            background: rgba(255, 215, 0, 0.1);
            border: 1px dashed rgba(255, 215, 0, 0.5);
            border-radius: 10px;
            padding: 12px 20px;
            margin: 0 auto 20px;
            max-width: 500px;
            font-size: 0.95rem;
            color: #ffd700;
        }

        .hint-comment::before {
            content: 'ğŸ’¡ ';
        }

        .treasure-box {
            background: linear-gradient(145deg, #8b4513, #654321);
            border: 8px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            margin: 20px auto;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        .treasure-box::before {
            content: 'ğŸ”’';
            font-size: 3rem;
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }

        .treasure-box.unlocked::before {
            content: 'ğŸ”“';
            animation: unlock 0.5s ease-out;
        }

        @keyframes unlock {
            0% { transform: translateX(-50%) rotate(0deg); }
            50% { transform: translateX(-50%) rotate(-20deg); }
            100% { transform: translateX(-50%) rotate(0deg); }
        }

        .code-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0 20px;
        }

        .code-digit {
            width: 70px;
            height: 90px;
            background: linear-gradient(180deg, #2a2a2a, #1a1a1a);
            border: 3px solid #ffd700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
        }

        .code-digit.solved {
            background: linear-gradient(180deg, #2d4a2d, #1a3a1a);
            animation: glow 1s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 0 10px rgba(0, 255, 0, 0.3); }
            to { box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 0 20px rgba(0, 255, 0, 0.6); }
        }

        .fragments-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .fragment {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .fragment.active {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .fragment.completed {
            border-color: #4ade80;
            background: rgba(0, 100, 0, 0.2);
        }

        .fragment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .fragment-icon {
            font-size: 2rem;
        }

        .fragment-title {
            font-size: 1.2rem;
            color: #ffd700;
        }

        .fragment-subtitle {
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-left: auto;
        }

        .level-indicator {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .level-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #444;
            transition: all 0.3s ease;
        }

        .level-dot.active {
            background: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        .level-dot.failed {
            background: #ef4444;
        }

        .question-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .question-level {
            font-size: 0.8rem;
            color: #ffd700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .question-level::before {
            content: 'âš¡';
        }

        .question-text {
            font-size: 1rem;
            line-height: 1.8;
            color: #e8d5b7;
        }

        /* Ruby styling */
        ruby {
            ruby-position: over;
        }

        rt {
            font-size: 0.6em;
            color: #a0a0a0;
        }

        .answer-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .answer-input {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            font-size: 1.2rem;
            border: 2px solid #ffd700;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            color: #ffd700;
            text-align: center;
            outline: none;
        }

        .answer-input:focus {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .submit-btn {
            padding: 12px 25px;
            font-size: 1rem;
            background: linear-gradient(145deg, #ffd700, #b8860b);
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .submit-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }

        .hint-btn {
            padding: 12px 20px;
            font-size: 0.9rem;
            background: transparent;
            border: 2px solid #a0a0a0;
            border-radius: 8px;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hint-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
        }

        .hint-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feedback.correct {
            display: block;
            background: rgba(0, 200, 0, 0.2);
            border: 1px solid #4ade80;
            color: #4ade80;
        }

        .feedback.wrong {
            display: block;
            background: rgba(200, 0, 0, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .completion-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }

        .completion-overlay.show {
            display: flex;
        }

        .completion-content {
            text-align: center;
            padding: 40px;
            max-width: 600px;
        }

        .completion-content h2 {
            font-size: 2.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        .completion-content .treasure-icon {
            font-size: 8rem;
            margin: 30px 0;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .completion-content p {
            font-size: 1.2rem;
            line-height: 1.8;
            color: #e8d5b7;
        }

        .sparkles {
            position: fixed;
            pointer-events: none;
            z-index: 999;
        }

        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            animation: sparkle 1s ease-out forwards;
        }

        @keyframes sparkle {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(180deg); opacity: 0; }
        }

        .math-formula {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            background: rgba(255, 215, 0, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .code-digit { width: 60px; height: 75px; font-size: 2.5rem; }
            .fragment { padding: 15px; }
            .answer-section { flex-direction: column; }
            .answer-input, .submit-btn, .hint-btn { width: 100%; }
            .fragment-title { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ´â€â˜ ï¸ <ruby>æœ€å¾Œ<rt>ã•ã„ã”</rt></ruby>ã®<ruby>è©¦ç·´<rt>ã—ã‚Œã‚“</rt></ruby> âš”ï¸</h1>
        
        <div class="hint-comment">
            <ruby>é›£<rt>ã‚€ãšã‹</rt></ruby>ã—ã‹ã£ãŸã‚‰ã€Œ<ruby>é™å‚<rt>ã“ã†ã•ã‚“</rt></ruby>ã€ã‚’<ruby>æŠ¼<rt>ãŠ</rt></ruby>ã™ã¨<ruby>ç°¡å˜<rt>ã‹ã‚“ãŸã‚“</rt></ruby>ãª<ruby>å•é¡Œ<rt>ã‚‚ã‚“ã ã„</rt></ruby>ã«ãªã‚‹ã‚ˆï¼
        </div>
        
        <div class="treasure-box" id="treasureBox">
            <p style="text-align: center; margin-bottom: 10px; color: #a0a0a0;"><ruby>è§£éŒ <rt>ã‹ã„ã˜ã‚‡ã†</rt></ruby><ruby>ç•ªå·<rt>ã°ã‚“ã”ã†</rt></ruby></p>
            <div class="code-display">
                <div class="code-digit" id="digit1">?</div>
                <div class="code-digit" id="digit2">?</div>
                <div class="code-digit" id="digit3">?</div>
            </div>
            <p style="text-align: center; font-size: 0.9rem; color: #a0a0a0;">3ã¤ã®<ruby>æ–­ç‰‡<rt>ã ã‚“ãºã‚“</rt></ruby>ã‚’<ruby>é›†<rt>ã‚ã¤</rt></ruby>ã‚ã‚ˆ</p>
        </div>

        <div class="fragments-container">
            <!-- Fragment 1 -->
            <div class="fragment active" id="fragment1">
                <div class="fragment-header">
                    <span class="fragment-icon">ğŸ›¡ï¸</span>
                    <span class="fragment-title"><ruby>ç¬¬ä¸€<rt>ã ã„ã„ã¡</rt></ruby>ã®<ruby>æ–­ç‰‡<rt>ã ã‚“ãºã‚“</rt></ruby>ã€Œ<ruby>å¯¾<rt>ã¤ã„</rt></ruby>ã‚’<ruby>æˆ<rt>ãª</rt></ruby>ã™<ruby>ä¸–ç•Œ<rt>ã›ã‹ã„</rt></ruby>ã®<ruby>ç†<rt>ã“ã¨ã‚ã‚Š</rt></ruby>ã€</span>
                    <span class="fragment-subtitle" id="level1">Lvl.4</span>
                </div>
                <div class="level-indicator" id="levelIndicator1">
                    <div class="level-dot active"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                </div>
                <div class="question-box">
                    <div class="question-level"><ruby>é›£æ˜“åº¦<rt>ãªã‚“ã„ã©</rt></ruby> <span id="diffLabel1">4</span></div>
                    <p class="question-text" id="question1"><ruby>æ•°å­¦ç•Œ<rt>ã™ã†ãŒãã‹ã„</rt></ruby>ã®<ruby>æœªè§£æ±ºé›£å•<rt>ã¿ã‹ã„ã‘ã¤ãªã‚“ã‚‚ã‚“</rt></ruby>ã€Œã‚´ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ<ruby>äºˆæƒ³<rt>ã‚ˆãã†</rt></ruby>ã€ã«ãŠã„ã¦ã€<ruby>å…¨<rt>ã™ã¹</rt></ruby>ã¦ã®<ruby>å¶æ•°<rt>ãã†ã™ã†</rt></ruby>ã‚’<ruby>å½¢ä½œ<rt>ã‹ãŸã¡ã¥ã</rt></ruby>ã‚‹<ruby>æœ€å°<rt>ã•ã„ã—ã‚‡ã†</rt></ruby>ã®<ruby>ç´ æ•°<rt>ãã™ã†</rt></ruby>ã¯ï¼Ÿ</p>
                </div>
                <div class="answer-section">
                    <input type="text" class="answer-input" id="answer1" placeholder="ç­”ãˆã‚’å…¥åŠ›..." autocomplete="off">
                    <button class="submit-btn" id="submit1" onclick="checkAnswer(1)"><ruby>è§£ç­”<rt>ã‹ã„ã¨ã†</rt></ruby></button>
                    <button class="hint-btn" id="hint1" onclick="showHint(1)">ğŸ’¡ <ruby>é™å‚<rt>ã“ã†ã•ã‚“</rt></ruby></button>
                </div>
                <div class="feedback" id="feedback1"></div>
            </div>

            <!-- Fragment 2 -->
            <div class="fragment" id="fragment2">
                <div class="fragment-header">
                    <span class="fragment-icon">âš–ï¸</span>
                    <span class="fragment-title"><ruby>ç¬¬äºŒ<rt>ã ã„ã«</rt></ruby>ã®<ruby>æ–­ç‰‡<rt>ã ã‚“ãºã‚“</rt></ruby>ã€Œ<ruby>ä¸€æ¡<rt>ã²ã¨ã‘ãŸ</rt></ruby>ã®<ruby>æ¥µ<rt>ãã‚</rt></ruby>ã¿ã«<ruby>å›è‡¨<rt>ãã‚“ã‚Šã‚“</rt></ruby>ã™ã‚‹<ruby>æ•°<rt>ã‹ãš</rt></ruby>ã€</span>
                    <span class="fragment-subtitle" id="level2">Lvl.4</span>
                </div>
                <div class="level-indicator" id="levelIndicator2">
                    <div class="level-dot active"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                </div>
                <div class="question-box">
                    <div class="question-level"><ruby>é›£æ˜“åº¦<rt>ãªã‚“ã„ã©</rt></ruby> <span id="diffLabel2">4</span></div>
                    <p class="question-text" id="question2"><ruby>å…¨<rt>ã™ã¹</rt></ruby>ã¦ã®<ruby>å…ƒç´ <rt>ã’ã‚“ã</rt></ruby>ã®<ruby>ä¸­<rt>ãªã‹</rt></ruby>ã§<ruby>æœ€<rt>ã‚‚ã£ã¨</rt></ruby>ã‚‚<ruby>å¼·<rt>ã¤ã‚ˆ</rt></ruby>ã„ã€Œ<ruby>é›»æ°—é™°æ€§åº¦<rt>ã§ã‚“ãã„ã‚“ã›ã„ã©</rt></ruby>ã€ã‚’<ruby>æŒ<rt>ã‚‚</rt></ruby>ã¡ã€<ruby>ä»–<rt>ã»ã‹</rt></ruby>ã®<ruby>ç‰©è³ª<rt>ã¶ã£ã—ã¤</rt></ruby>ã‹ã‚‰<ruby>é›»å­<rt>ã§ã‚“ã—</rt></ruby>ã‚’<ruby>å¥ª<rt>ã†ã°</rt></ruby>ã„<ruby>å»<rt>ã•</rt></ruby>ã‚‹<ruby>åŸå­ç•ªå·<rt>ã’ã‚“ã—ã°ã‚“ã”ã†</rt></ruby>9ã®<ruby>å…ƒç´ <rt>ã’ã‚“ã</rt></ruby>ã¯ï¼Ÿ</p>
                </div>
                <div class="answer-section">
                    <input type="text" class="answer-input" id="answer2" placeholder="ç­”ãˆã‚’å…¥åŠ›..." autocomplete="off" disabled>
                    <button class="submit-btn" id="submit2" onclick="checkAnswer(2)" disabled><ruby>è§£ç­”<rt>ã‹ã„ã¨ã†</rt></ruby></button>
                    <button class="hint-btn" id="hint2" onclick="showHint(2)" disabled>ğŸ’¡ <ruby>é™å‚<rt>ã“ã†ã•ã‚“</rt></ruby></button>
                </div>
                <div class="feedback" id="feedback2"></div>
            </div>

            <!-- Fragment 3 -->
            <div class="fragment" id="fragment3">
                <div class="fragment-header">
                    <span class="fragment-icon">ğŸ•¯ï¸</span>
                    <span class="fragment-title"><ruby>ç¬¬ä¸‰<rt>ã ã„ã•ã‚“</rt></ruby>ã®<ruby>æ–­ç‰‡<rt>ã ã‚“ãºã‚“</rt></ruby>ã€Œ<ruby>ç‰¹ç•°ç‚¹<rt>ã¨ãã„ã¦ã‚“</rt></ruby>ã¨ã—ã¦ã®<ruby>å­¤ç‹¬<rt>ã“ã©ã</rt></ruby>ã€</span>
                    <span class="fragment-subtitle" id="level3">Lvl.4</span>
                </div>
                <div class="level-indicator" id="levelIndicator3">
                    <div class="level-dot active"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                    <div class="level-dot"></div>
                </div>
                <div class="question-box">
                    <div class="question-level"><ruby>é›£æ˜“åº¦<rt>ãªã‚“ã„ã©</rt></ruby> <span id="diffLabel3">4</span></div>
                    <p class="question-text" id="question3"><ruby>æ•°å­¦<rt>ã™ã†ãŒã</rt></ruby>ã®<ruby>æµ·<rt>ã†ã¿</rt></ruby>ã«ãŠã„ã¦ã€ã©ã‚“ãª<ruby>æ•°å­—<rt>ã™ã†ã˜</rt></ruby>ã«<ruby>æ›<rt>ã‹</rt></ruby>ã‘ã¦ã‚‚ãã®<ruby>å§¿<rt>ã™ãŒãŸ</rt></ruby>ã‚’<ruby>å¤‰<rt>ã‹</rt></ruby>ãˆãªã„ã€Œ<ruby>ä¹—æ³•<rt>ã˜ã‚‡ã†ã»ã†</rt></ruby>ã®<ruby>å˜ä½å…ƒ<rt>ãŸã‚“ã„ã’ã‚“</rt></ruby>ã€ã¯ï¼Ÿ</p>
                </div>
                <div class="answer-section">
                    <input type="text" class="answer-input" id="answer3" placeholder="ç­”ãˆã‚’å…¥åŠ›..." autocomplete="off" disabled>
                    <button class="submit-btn" id="submit3" onclick="checkAnswer(3)" disabled><ruby>è§£ç­”<rt>ã‹ã„ã¨ã†</rt></ruby></button>
                    <button class="hint-btn" id="hint3" onclick="showHint(3)" disabled>ğŸ’¡ <ruby>é™å‚<rt>ã“ã†ã•ã‚“</rt></ruby></button>
                </div>
                <div class="feedback" id="feedback3"></div>
            </div>
        </div>
    </div>

    <!-- Completion Overlay -->
    <div class="completion-overlay" id="completionOverlay">
        <div class="completion-content">
            <h2>ğŸŠ <ruby>å®ç®±<rt>ãŸã‹ã‚‰ã°ã“</rt></ruby><ruby>è§£éŒ <rt>ã‹ã„ã˜ã‚‡ã†</rt></ruby>ï¼ğŸŠ</h2>
            <div class="treasure-icon">ğŸ’</div>
            <p>ãŠã‚ã§ã¨ã†ã€<ruby>å‹‡æ•¢<rt>ã‚†ã†ã‹ã‚“</rt></ruby>ãªã‚‹<ruby>æ¢æ¤œè€…<rt>ãŸã‚“ã‘ã‚“ã—ã‚ƒ</rt></ruby>ã‚ˆï¼<br><br>
            <ruby>æ±<rt>ãªã‚“ã˜</rt></ruby>ã¯<ruby>çŸ¥æµ<rt>ã¡ãˆ</rt></ruby>ã¨<ruby>å‹‡æ°—<rt>ã‚†ã†ã</rt></ruby>ã‚’ã‚‚ã£ã¦ã€<br>
            3ã¤ã®<ruby>å¤ä»£<rt>ã“ã ã„</rt></ruby>ã®<ruby>è¬<rt>ãªã</rt></ruby>ã‚’<ruby>è§£<rt>ã¨</rt></ruby>ã<ruby>æ˜<rt>ã‚</rt></ruby>ã‹ã—ãŸã€‚<br><br>
            <strong style="color: #ffd700;"><ruby>è§£éŒ <rt>ã‹ã„ã˜ã‚‡ã†</rt></ruby><ruby>ç•ªå·<rt>ã°ã‚“ã”ã†</rt></ruby>: 2 - 9 - 1</strong><br><br>
            ã•ã‚ã€<ruby>å®ç®±<rt>ãŸã‹ã‚‰ã°ã“</rt></ruby>ã‚’<ruby>é–‹<rt>ã‚</rt></ruby>ã‘ã‚‹ãŒã‚ˆã„ï¼</p>
        </div>
    </div>

    <div class="sparkles" id="sparkles"></div>

    <script>
        // Questions data (with ruby tags for furigana)
        const questions = {
            1: {
                answer: 2,
                levels: [
                    { level: 4, text: '<ruby>æ•°å­¦ç•Œ<rt>ã™ã†ãŒãã‹ã„</rt></ruby>ã®<ruby>æœªè§£æ±ºé›£å•<rt>ã¿ã‹ã„ã‘ã¤ãªã‚“ã‚‚ã‚“</rt></ruby>ã€Œã‚´ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ<ruby>äºˆæƒ³<rt>ã‚ˆãã†</rt></ruby>ã€ã«ãŠã„ã¦ã€<ruby>å…¨<rt>ã™ã¹</rt></ruby>ã¦ã®<ruby>å¶æ•°<rt>ãã†ã™ã†</rt></ruby>ã‚’<ruby>å½¢ä½œ<rt>ã‹ãŸã¡ã¥ã</rt></ruby>ã‚‹<ruby>æœ€å°<rt>ã•ã„ã—ã‚‡ã†</rt></ruby>ã®<ruby>ç´ æ•°<rt>ãã™ã†</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 3, text: '<ruby>å®‡å®™<rt>ã†ã¡ã‚…ã†</rt></ruby>ã‚’<ruby>æ¼‚<rt>ãŸã ã‚ˆ</rt></ruby>ã†ã€Œ<ruby>é€£æ˜Ÿç³»<rt>ã‚Œã‚“ã›ã„ã‘ã„</rt></ruby>ã€ã«ãŠã„ã¦ã€<ruby>äº’<rt>ãŸãŒ</rt></ruby>ã„ã®<ruby>é‡åŠ›<rt>ã˜ã‚…ã†ã‚Šã‚‡ã</rt></ruby>ã§<ruby>å¼•<rt>ã²</rt></ruby>ã<ruby>ä»˜<rt>ã¤</rt></ruby>ã‘<ruby>åˆ<rt>ã‚</rt></ruby>ã„ã€<ruby>å…±<rt>ã¨ã‚‚</rt></ruby>ã«<ruby>å›è»¢<rt>ã‹ã„ã¦ã‚“</rt></ruby>ã™ã‚‹<ruby>å¤©ä½“<rt>ã¦ã‚“ãŸã„</rt></ruby>ã®<ruby>æ•°<rt>ã‹ãš</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 2, text: '<ruby>ç”Ÿå‘½<rt>ã›ã„ã‚ã„</rt></ruby>ã®<ruby>èºæ—‹<rt>ã‚‰ã›ã‚“</rt></ruby>ã€‚DNAã®<ruby>äºŒé‡æ§‹é€ <rt>ã«ã˜ã‚…ã†ã“ã†ãã†</rt></ruby>ã‚’<ruby>å½¢æˆ<rt>ã‘ã„ã›ã„</rt></ruby>ã™ã‚‹ãƒãƒªãƒŒã‚¯ãƒ¬ã‚ªãƒãƒ‰<ruby>é–<rt>ã•</rt></ruby>ã®<ruby>æ•°<rt>ã‹ãš</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 1, text: 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®<ruby>æ·±æ·µ<rt>ã—ã‚“ãˆã‚“</rt></ruby>ã€‚0ã¨1ã€ã™ãªã‚ã¡ã€Œ<ruby>äºŒé€²æ³•<rt>ã«ã—ã‚“ã»ã†</rt></ruby>ã€ã§<ruby>æ‰±<rt>ã‚ã¤ã‹</rt></ruby>ã‚ã‚Œã‚‹<ruby>æƒ…å ±<rt>ã˜ã‚‡ã†ã»ã†</rt></ruby>ã®<ruby>ç¨®é¡<rt>ã—ã‚…ã‚‹ã„</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 0, text: 'ã„ã¡ã€<strong>ï¼Ÿ</strong>ã€ã•ã‚“ã€ã—ã€ã”...<ruby>æ•°<rt>ã‹ã</rt></ruby>ãˆã¦ã¿ã‚ˆã†ï¼ã€Œ<ruby>ï¼Ÿ<rt>ã¯ã¦ãª</rt></ruby>ã€ã«<ruby>å…¥<rt>ã¯ã„</rt></ruby>ã‚‹<ruby>æ•°å­—<rt>ã™ã†ã˜</rt></ruby>ã¯ï¼Ÿ' }
                ]
            },
            2: {
                answer: 9,
                levels: [
                    { level: 4, text: '<ruby>å…¨<rt>ã™ã¹</rt></ruby>ã¦ã®<ruby>å…ƒç´ <rt>ã’ã‚“ã</rt></ruby>ã®<ruby>ä¸­<rt>ãªã‹</rt></ruby>ã§<ruby>æœ€<rt>ã‚‚ã£ã¨</rt></ruby>ã‚‚<ruby>å¼·<rt>ã¤ã‚ˆ</rt></ruby>ã„ã€Œ<ruby>é›»æ°—é™°æ€§åº¦<rt>ã§ã‚“ãã„ã‚“ã›ã„ã©</rt></ruby>ã€ã‚’<ruby>æŒ<rt>ã‚‚</rt></ruby>ã¡ã€<ruby>ä»–<rt>ã»ã‹</rt></ruby>ã®<ruby>ç‰©è³ª<rt>ã¶ã£ã—ã¤</rt></ruby>ã‹ã‚‰<ruby>é›»å­<rt>ã§ã‚“ã—</rt></ruby>ã‚’<ruby>å¥ª<rt>ã†ã°</rt></ruby>ã„<ruby>å»<rt>ã•</rt></ruby>ã‚‹<ruby>åŸå­ç•ªå·<rt>ã’ã‚“ã—ã°ã‚“ã”ã†</rt></ruby>9ã®<ruby>å…ƒç´ <rt>ã’ã‚“ã</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 3, text: 'ã‹ã¤ã¦<ruby>å¤ªé™½ç³»<rt>ãŸã„ã‚ˆã†ã‘ã„</rt></ruby>ã®<ruby>æœ<rt>ã¯</rt></ruby>ã¦ã«<ruby>å†¥ç‹æ˜Ÿ<rt>ã‚ã„ãŠã†ã›ã„</rt></ruby>ãŒ<ruby>æ•°<rt>ã‹ã</rt></ruby>ãˆã‚‰ã‚Œã¦ã„ãŸ<ruby>é ƒ<rt>ã“ã‚</rt></ruby>ã€<ruby>æ•™ç§‘æ›¸<rt>ãã‚‡ã†ã‹ã—ã‚‡</rt></ruby>ã«<ruby>è¨˜<rt>ã—ã‚‹</rt></ruby>ã•ã‚Œã¦ã„ãŸ<ruby>æƒ‘æ˜Ÿ<rt>ã‚ãã›ã„</rt></ruby>ã®<ruby>ç·æ•°<rt>ãã†ã™ã†</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 2, text: '<ruby>é­”æ³•é™£<rt>ã¾ã»ã†ã˜ã‚“</rt></ruby>ï¼ˆ3Ã—3ï¼‰ã«ãŠã„ã¦ã€<ruby>ç¸¦<rt>ãŸã¦</rt></ruby>ãƒ»<ruby>æ¨ª<rt>ã‚ˆã“</rt></ruby>ãƒ»<ruby>æ–œ<rt>ãªãª</rt></ruby>ã‚ã®<ruby>å’Œ<rt>ã‚</rt></ruby>ã‚’<ruby>ä¸€å®š<rt>ã„ã£ã¦ã„</rt></ruby>ã«ã™ã‚‹ãŸã‚ã«<ruby>é…ç½®<rt>ã¯ã„ã¡</rt></ruby>ã•ã‚Œã‚‹ã€<ruby>ä¸€æ¡<rt>ã²ã¨ã‘ãŸ</rt></ruby>ã§<ruby>æœ€å¤§<rt>ã•ã„ã ã„</rt></ruby>ã®<ruby>æ­£<rt>ã›ã„</rt></ruby>ã®<ruby>æ•´æ•°<rt>ã›ã„ã™ã†</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 1, text: '<span class="math-formula">âˆš81</span>ã€‚ã“ã®<ruby>æ•°å¼<rt>ã™ã†ã—ã</rt></ruby>ã‚’<ruby>è§£<rt>ã¨</rt></ruby>ã<ruby>æ˜<rt>ã‚</rt></ruby>ã‹ã—ãŸ<ruby>å…ˆ<rt>ã•ã</rt></ruby>ã«<ruby>ç¾<rt>ã‚ã‚‰ã‚</rt></ruby>ã‚Œã‚‹ã€<ruby>ä¹ä¹<rt>ãã</rt></ruby>ã®<ruby>çµ‚ç€ç‚¹<rt>ã—ã‚…ã†ã¡ã‚ƒãã¦ã‚“</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 0, text: '1ã€2ã€3ã€4ã€5ã€6ã€7ã€8ã€<strong>ï¼Ÿ</strong>...<ruby>ä¸€æ¡<rt>ã²ã¨ã‘ãŸ</rt></ruby>ã®<ruby>æ•°å­—<rt>ã™ã†ã˜</rt></ruby>ã§<ruby>ä¸€ç•ªå¤§<rt>ã„ã¡ã°ã‚“ãŠãŠ</rt></ruby>ãã„ã®ã¯ï¼Ÿ' }
                ]
            },
            3: {
                answer: 1,
                levels: [
                    { level: 4, text: '<ruby>æ•°å­¦<rt>ã™ã†ãŒã</rt></ruby>ã®<ruby>æµ·<rt>ã†ã¿</rt></ruby>ã«ãŠã„ã¦ã€ã©ã‚“ãª<ruby>æ•°å­—<rt>ã™ã†ã˜</rt></ruby>ã«<ruby>æ›<rt>ã‹</rt></ruby>ã‘ã¦ã‚‚ãã®<ruby>å§¿<rt>ã™ãŒãŸ</rt></ruby>ã‚’<ruby>å¤‰<rt>ã‹</rt></ruby>ãˆãªã„ã€Œ<ruby>ä¹—æ³•<rt>ã˜ã‚‡ã†ã»ã†</rt></ruby>ã®<ruby>å˜ä½å…ƒ<rt>ãŸã‚“ã„ã’ã‚“</rt></ruby>ã€ã¯ï¼Ÿ' },
                    { level: 3, text: '<ruby>å®‡å®™é–‹é—¢<rt>ã†ã¡ã‚…ã†ã‹ã„ã³ã‚ƒã</rt></ruby>ã®<ruby>ç¬é–“<rt>ã—ã‚…ã‚“ã‹ã‚“</rt></ruby>ã€<ruby>æœ€åˆ<rt>ã•ã„ã—ã‚‡</rt></ruby>ã«<ruby>ç”Ÿ<rt>ã†</rt></ruby>ã¾ã‚ŒãŸ<ruby>æœ€<rt>ã‚‚ã£ã¨</rt></ruby>ã‚‚<ruby>è»½<rt>ã‹ã‚‹</rt></ruby>ã„<ruby>å…ƒç´ <rt>ã’ã‚“ã</rt></ruby>ã€Œ<ruby>æ°´ç´ <rt>ã™ã„ã</rt></ruby>ã€ã€‚ãã®<ruby>ä¸­æ€§å­<rt>ã¡ã‚…ã†ã›ã„ã—</rt></ruby>ã‚’<ruby>æŒ<rt>ã‚‚</rt></ruby>ãŸãªã„<ruby>åŸå­æ ¸<rt>ã’ã‚“ã—ã‹ã</rt></ruby>ã®<ruby>ç•ªå·<rt>ã°ã‚“ã”ã†</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 2, text: '<ruby>å­¤ç‹¬<rt>ã“ã©ã</rt></ruby>ãª<ruby>å®šç¾©<rt>ã¦ã„ã</rt></ruby>ã€‚<ruby>ç´ æ•°<rt>ãã™ã†</rt></ruby>ï¼ˆ<ruby>ç´„æ•°<rt>ã‚„ãã™ã†</rt></ruby>2ã¤ï¼‰ã«ã‚‚ã€<ruby>åˆæˆæ•°<rt>ã”ã†ã›ã„ã™ã†</rt></ruby>ï¼ˆ<ruby>ç´„æ•°<rt>ã‚„ãã™ã†</rt></ruby>3ã¤<ruby>ä»¥ä¸Š<rt>ã„ã˜ã‚‡ã†</rt></ruby>ï¼‰ã«ã‚‚<ruby>åˆ†é¡<rt>ã¶ã‚“ã‚‹ã„</rt></ruby>ã•ã‚Œãªã„<ruby>å”¯ä¸€<rt>ã‚†ã„ã„ã¤</rt></ruby>ã®<ruby>è‡ªç„¶æ•°<rt>ã—ãœã‚“ã™ã†</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 1, text: '<ruby>ç„¡<rt>ã‚€</rt></ruby>ã¸ã®<ruby>å¸°é‚„<rt>ãã‹ã‚“</rt></ruby>ã€‚0<ruby>ä»¥å¤–<rt>ã„ãŒã„</rt></ruby>ã®ã‚ã‚‰ã‚†ã‚‹<ruby>æ•°<rt>ã™ã†</rt></ruby> <span class="math-formula">x</span> ã«ãŠã„ã¦ã€<span class="math-formula">x<sup>0</sup></span>ï¼ˆ0<ruby>ä¹—<rt>ã˜ã‚‡ã†</rt></ruby>ï¼‰ãŒ<ruby>ç­‰<rt>ã²ã¨</rt></ruby>ã—ã<ruby>è¡Œ<rt>ã„</rt></ruby>ã<ruby>ç€<rt>ã¤</rt></ruby>ã<ruby>å…ˆ<rt>ã•ã</rt></ruby>ã¯ï¼Ÿ' },
                    { level: 0, text: '<ruby>ä¸€ç•ª<rt>ã„ã¡ã°ã‚“</rt></ruby><ruby>æœ€åˆ<rt>ã•ã„ã—ã‚‡</rt></ruby>ã®<ruby>æ•°å­—<rt>ã™ã†ã˜</rt></ruby>ï¼<ruby>æŒ‡<rt>ã‚†ã³</rt></ruby>ã‚’<strong>ï¼Ÿ</strong><ruby>æœ¬<rt>ã»ã‚“</rt></ruby><ruby>ç«‹<rt>ãŸ</rt></ruby>ã¦ã¦ã€Œã„ã¡ï¼ã€<ruby>ä½•æœ¬<rt>ãªã‚“ã¼ã‚“</rt></ruby><ruby>ç«‹<rt>ãŸ</rt></ruby>ã¦ãŸï¼Ÿ' }
                ]
            }
        };

        // State
        let currentLevels = { 1: 0, 2: 0, 3: 0 }; // Index into levels array (0 = Lvl.4, 4 = Lvl.0)
        let solved = { 1: false, 2: false, 3: false };
        let currentFragment = 1;

        // Check answer
        function checkAnswer(fragment) {
            const input = document.getElementById(`answer${fragment}`);
            const feedback = document.getElementById(`feedback${fragment}`);
            const userAnswer = input.value.trim();
            const correctAnswer = questions[fragment].answer;

            // Accept various formats
            const normalizedAnswer = normalizeAnswer(userAnswer);
            
            if (normalizedAnswer === correctAnswer) {
                // Correct!
                feedback.className = 'feedback correct';
                feedback.innerHTML = 'âœ¨ <ruby>æ­£è§£<rt>ã›ã„ã‹ã„</rt></ruby>ï¼<ruby>æ–­ç‰‡<rt>ã ã‚“ãºã‚“</rt></ruby>ã‚’<ruby>ç²å¾—<rt>ã‹ãã¨ã</rt></ruby>ã—ãŸï¼';
                solved[fragment] = true;
                
                // Update UI
                document.getElementById(`digit${fragment}`).textContent = correctAnswer;
                document.getElementById(`digit${fragment}`).classList.add('solved');
                document.getElementById(`fragment${fragment}`).classList.remove('active');
                document.getElementById(`fragment${fragment}`).classList.add('completed');
                
                // Disable inputs
                input.disabled = true;
                document.getElementById(`submit${fragment}`).disabled = true;
                document.getElementById(`hint${fragment}`).disabled = true;

                // Create sparkles
                createSparkles(event);

                // Check if all solved
                if (solved[1] && solved[2] && solved[3]) {
                    setTimeout(showCompletion, 1000);
                } else {
                    // Activate next fragment
                    activateNextFragment(fragment);
                }
            } else {
                // Wrong
                feedback.className = 'feedback wrong';
                
                const levelIndex = currentLevels[fragment];
                if (levelIndex < 4) {
                    // Move to easier question
                    currentLevels[fragment]++;
                    updateLevelIndicator(fragment);
                    
                    feedback.innerHTML = 'âŒ <ruby>ä¸æ­£è§£<rt>ãµã›ã„ã‹ã„</rt></ruby>...ã‚ˆã‚Š<ruby>æ˜“<rt>ã‚„ã•</rt></ruby>ã—ã<ruby>å•<rt>ã¨</rt></ruby>ã„ã¸<ruby>å°<rt>ã¿ã¡ã³</rt></ruby>ã“ã†ã€‚';
                    
                    setTimeout(() => {
                        updateQuestion(fragment);
                        feedback.style.display = 'none';
                        input.value = '';
                    }, 1500);
                } else {
                    // Already at easiest level
                    feedback.innerHTML = 'âŒ <ruby>ä¸æ­£è§£<rt>ãµã›ã„ã‹ã„</rt></ruby>...ã‚‚ã†<ruby>ä¸€åº¦<rt>ã„ã¡ã©</rt></ruby><ruby>è€ƒ<rt>ã‹ã‚“ãŒ</rt></ruby>ãˆã¦ã¿ã‚ˆã†ã€‚';
                }
            }
        }

        function normalizeAnswer(answer) {
            // Convert various formats to number
            const numMap = {
                'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5,
                'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'é›¶': 0,
                'ï¼‘': 1, 'ï¼’': 2, 'ï¼“': 3, 'ï¼”': 4, 'ï¼•': 5,
                'ï¼–': 6, 'ï¼—': 7, 'ï¼˜': 8, 'ï¼™': 9, 'ï¼': 0,
                'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
                'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'zero': 0,
                'ãƒ•ãƒƒç´ ': 9, 'ãµã£ã': 9, 'f': 9, 'fluorine': 9
            };

            const lower = answer.toLowerCase();
            if (numMap[lower] !== undefined) return numMap[lower];
            if (numMap[answer] !== undefined) return numMap[answer];
            
            const num = parseInt(answer);
            if (!isNaN(num)) return num;
            
            return answer;
        }

        function updateQuestion(fragment) {
            const levelIndex = currentLevels[fragment];
            const questionData = questions[fragment].levels[levelIndex];
            
            document.getElementById(`question${fragment}`).innerHTML = questionData.text;
            document.getElementById(`level${fragment}`).textContent = `Lvl.${questionData.level}`;
            document.getElementById(`diffLabel${fragment}`).textContent = questionData.level;
        }

        function updateLevelIndicator(fragment) {
            const indicator = document.getElementById(`levelIndicator${fragment}`);
            const dots = indicator.querySelectorAll('.level-dot');
            const levelIndex = currentLevels[fragment];
            
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'failed');
                if (index < levelIndex) {
                    dot.classList.add('failed');
                } else if (index === levelIndex) {
                    dot.classList.add('active');
                }
            });
        }

        function activateNextFragment(current) {
            const next = current + 1;
            if (next <= 3 && !solved[next]) {
                setTimeout(() => {
                    document.getElementById(`fragment${next}`).classList.add('active');
                    document.getElementById(`answer${next}`).disabled = false;
                    document.getElementById(`submit${next}`).disabled = false;
                    document.getElementById(`hint${next}`).disabled = false;
                    document.getElementById(`answer${next}`).focus();
                }, 500);
            }
        }

        function showHint(fragment) {
            // Jump to easiest level (Lvl.0)
            currentLevels[fragment] = 4;
            updateLevelIndicator(fragment);
            updateQuestion(fragment);
            
            const feedback = document.getElementById(`feedback${fragment}`);
            feedback.className = 'feedback wrong';
            feedback.innerHTML = 'ğŸ’¡ <ruby>æœ€<rt>ã‚‚ã£ã¨</rt></ruby>ã‚‚<ruby>æ˜“<rt>ã‚„ã•</rt></ruby>ã—ã<ruby>å•<rt>ã¨</rt></ruby>ã„ã¸...';
            feedback.style.display = 'block';
            
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 1500);
        }

        function showCompletion() {
            document.getElementById('treasureBox').classList.add('unlocked');
            
            setTimeout(() => {
                document.getElementById('completionOverlay').classList.add('show');
                createCelebration();
            }, 500);
        }

        function createSparkles(e) {
            const sparkles = document.getElementById('sparkles');
            const rect = e.target.getBoundingClientRect();
            
            for (let i = 0; i < 10; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = (rect.left + rect.width/2 + (Math.random() - 0.5) * 100) + 'px';
                sparkle.style.top = (rect.top + (Math.random() - 0.5) * 50) + 'px';
                sparkles.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        function createCelebration() {
            const sparkles = document.getElementById('sparkles');
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = Math.random() * window.innerWidth + 'px';
                    sparkle.style.top = Math.random() * window.innerHeight + 'px';
                    sparkle.style.background = ['#ffd700', '#ff6b6b', '#4ade80', '#60a5fa'][Math.floor(Math.random() * 4)];
                    sparkles.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 1000);
                }, i * 50);
            }
        }

        // Enter key to submit
        document.querySelectorAll('.answer-input').forEach((input, index) => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !input.disabled) {
                    checkAnswer(index + 1);
                }
            });
        });
    </script>
</body>
</html>
